{!-- Store the specs (IDs) that this product supports
  You need this for two reasons:
    1: Match up all other products that support the same specs
    2: When listing the specs of the compatible product, limit to the specs supported by THIS product
--}

{exp:stash:set_value name="consumable_specs" parse="inward" value='{exp:playa:child_ids entry_id="{structure:page:entry_id}" field_id="21" col_id="15"}'}

{exp:stash:set_value name="output_specs" parse="inward" value='{exp:playa:child_ids entry_id="{structure:page:entry_id}" field_id="22" col_id="17"}'}

{!-- COMPATIBLE PRODUCERS --}
{exp:switchee variable="stash:consumable_specs" parse="inward"}

  {!-- Only run this if you have IDs to pair up --}
  {case value="#^\d#"}
    {exp:stash:set_list name="consumable_spec_data" parse_tags="yes"}
      {exp:channel:entries dynamic="no" parse="inward" entry_id="{exp:stash:consumable_specs}" orderby="title" sort="asc"}
        {stash:title}{title}{/stash:title}
        {stash:url}{cf-spec-text}{/stash:url}
        {stash:entry_id}{entry_id}{/stash:entry_id}
      {/exp:channel:entries}    
    {/exp:stash:set_list}
    
    {exp:stash:set_list name="compatible_providers" parse_tags="yes" parse_depth="2"}
      {exp:playa:parents
        channel="products"
        parse="inward"
        child_id="{exp:stash:consumable_specs}"
        parent_id="not {structure:page:entry_id}" {!-- Exclude the requesting product from results --}
        field_id="22"
        col_id="17"
        orderby="title"
        sort="asc"
        search:cf-pr-s-isconnector="IS_EMPTY" {!-- Excludes adapter products --}
        var_prefix="provider"
      }
        {stash:title}{provider:title}{/stash:title}
        {stash:url}{provider:page_url}{/stash:url}
        {stash:entry_id}{provider:entry_id}{/stash:entry_id}
        
        {exp:stash:parse}
          {exp:stash:set_value name="produced_specs" context="{provider:entry_id}" value='{exp:playa:child_ids channel="specifications" field_id="22" col_id="17" orderby="title" sort="asc"}'}
        {/exp:stash:parse}

        {stash:specifications}{exp:stash:get_list name="consumable_spec_data" against="entry_id" parse="inward" match="#{exp:stash:get name='produced_specs' context='{provider:entry_id}'}#" prefix="output_spec" backspace="2"}{output_spec:title}||{/exp:stash:get_list}{/stash:specifications}
        
        {stash:tooltip}        
          {structure:page:title} can consume the following specifications that {provider:title} outputs:
          {exp:stash:get_list name="consumable_spec_data" against="entry_id" parse="inward" match="#{exp:stash:get name='produced_specs' context='{provider:entry_id}'}#" prefix="output_spec"}
            {if {output_spec:count} != 1 && {output_spec:count} == {output_spec:total_results} && {output_spec:total_results} > 1}
            and
            {/if}
            {output_spec:title}{if {output_spec:count} != {output_spec:total_results} && {output_spec:total_results} > 1},{/if}{if {output_spec:count} == {output_spec:total_results}}.{/if}
          {/exp:stash:get_list}
        {/stash:tooltip}

      {/exp:playa:parents}
    {/exp:stash:set_list}

  {/case}
{/exp:switchee}

{!-- COMPATIBLE CONSUMERS --}
{exp:switchee variable="stash:output_specs" parse="inward"}
  {case value="#^\d#"}
  
    {exp:stash:set_list name="output_spec_data" parse_tags="yes"}
      {exp:channel:entries dynamic="no" parse="inward" entry_id="{exp:stash:output_specs}" orderby="title" sort="asc"}
        {stash:title}{title}{/stash:title}
        {stash:url}{cf-spec-text}{/stash:url}
        {stash:entry_id}{entry_id}{/stash:entry_id}
      {/exp:channel:entries}        
    {/exp:stash:set_list}
    
    {exp:stash:set_list name="compatible_consumers" parse_tags="yes" parse_depth="2"}
      {exp:playa:parents 
        channel="products"
        parse="inward"
        child_id="{exp:stash:output_specs}"
        parent_id="not {structure:page:entry_id}" {!-- Exclude the requesting product from results --}
        field_id="21"
        col_id="15"
        orderby="title"
        sort="asc"
        search:cf-pr-s-isconnector="IS_EMPTY" {!-- Excludes adapter products --}
        var_prefix="consumer"
      }

        {stash:title}{consumer:title}{/stash:title}
        {stash:url}{consumer:page_url}{/stash:url}
        {stash:entry_id}{consumer:entry_id}{/stash:entry_id}
        
        {exp:stash:parse}
          {exp:stash:set_value name="consumed_specs" context="{consumer:entry_id}" value='{exp:playa:child_ids channel="specifications" field_id="21" col_id="15" orderby="title" sort="asc"}'}
        {/exp:stash:parse}

        {stash:specifications}{exp:stash:get_list name="output_spec_data" against="entry_id" parse="inward" match="#{exp:stash:get name='consumed_specs' context='{consumer:entry_id}'}#" prefix="consumed_spec" backspace="2"}{consumed_spec:title}||{/exp:stash:get_list}{/stash:specifications}
        
        {stash:tooltip}        
          {consumer:title} can consume the following specifications that {structure:page:title} outputs:
          {exp:stash:get_list name="output_spec_data" against="entry_id" parse="inward" match="#{exp:stash:get name='consumed_specs' context='{consumer:entry_id}'}#" prefix="consumed_spec"}
            {if {consumed_spec:count} != 1 && {consumed_spec:count} == {consumed_spec:total_results} && {consumed_spec:total_results} > 1}
            and
            {/if}
            {consumed_spec:title}{if {consumed_spec:count} != {consumed_spec:total_results} && {consumed_spec:total_results} > 1},{/if}{if {consumed_spec:count} == {consumed_spec:total_results}}.{/if}
          {/exp:stash:get_list}
        {/stash:tooltip}

      {/exp:playa:parents}
    {/exp:stash:set_list}
    
  {/case}
{/exp:switchee}