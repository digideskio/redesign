{stash:embed:layouts:{stash:_layout}}

{exp:channel:entries
	entry_id="{structure:page:entry_id}"
  parse="inward"
	show_future_entries="yes"
  show_expired="yes"
	status="{stash:_status}"
  disable="{global:disable_default}"
  {if stash:_disable != ''}
    disable="{stash:_disable}"
  {/if}
  require_entry="yes"

}

	{if no_results}{redirect="404"}{/if}
	
	{!-- Capture all relationships in one pass --}
	{exp:stash:parse parse_depth="2"}
    {exp:playa:children parse="inward" var_prefix="child"}
      {exp:stash:append_list name="children"}
        {stash:channel_slug}{child:channel_short_name}{/stash:channel_slug}
        {stash:channel}{child:channel}{/stash:channel}
        {stash:url}{child:page_url}{/stash:url}
        {stash:text}{child:title}{/stash:text}
      {/exp:stash:append_list}
    {/exp:playa:children}

    {exp:playa:parents parse="inward" var_prefix="parent"}
      {exp:stash:append_list name="parents"}
        {stash:channel_slug}{parent:channel_short_name}{/stash:channel_slug}
        {stash:channel}{parent:channel}{/stash:channel}
        {stash:url}{parent:page_url}{/stash:url}
        {stash:text}{parent:title}{/stash:text}
      {/exp:stash:append_list}
    {/exp:playa:parents}
  {/exp:stash:parse}
  
	
	{exp:stash:set name="layout_deck_date"}{entry_date format="{lv-blogdateformat}"}{/exp:stash:set}
	{exp:stash:set name="layout_deck_date_w3c"}{entry_date format="{DATE_W3C}"}{/exp:stash:set}
	
	{!-- Primary body content --}
	{exp:stash:set name="layout_copy" match="#\S#"}
    {exp:switchee variable="stash:_type" parse="inward"}
    
      {case value="blog"}
        {cf-blog-w-body}
      {/case}
    
      {case value="resource"}
        {if cf-resource-cv-videos}
          {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
            {if video:service == "youtube"}
              {video:embed_code_hd}
            {if:else}
              {video:embed_code}
            {/if}										
          {/exp:channel_videos:videos}
        {if:elseif cf-resource-t-embed}
          {cf-resource-t-embed}
        {/if}
      
        {if cf-resource-w-desc == "" && cf-resource-cv-videos != ""}
          {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
            Description from {video:service}: {video:description}
          {/exp:channel_videos:videos}
        {if:else}
          {cf-resource-w-desc}
        {/if}
      {/case}
        
      {case value="tutorial"}
        {if cf-tut-w-body}
          {if cf-tut-m-altversions} 
            <p>(<i>Download as {cf-tut-m-altversions}{if row_count > 1 && total_rows == 2}&nbsp;or&nbsp;{/if}<a href="{altfile}">{altdescription}</a>{if row_count != total_rows && total_rows != 2},{/if}{/cf-tut-m-altversions}.</i>)</p>
          {/if}
          {cf-tut-w-body}
        {/if}
        {if cf-tutpage-w-body}{cf-tutpage-w-body}{/if}
      {/case}

      {case value="workgroup"}
        {exp:playa:parents channel="charters" field="cf-wgcharter-r-workgroup" status="open" limit="1" var_prefix="charter"}
          {!-- No charter? Just show the description --}
          {if no_parents}{cf-wg-w-description-en}{/if}
          
          {exp:stash:set_list name="tabs_workgroup_body"}
            {stash:label}Description{/stash:label}
            {stash:id}description{/stash:id}
            {stash:body}{cf-wg-w-description-en}{/stash:body}
            
            {stash:label}Charter{/stash:label}
            {stash:id}charter{/stash:id}
            {stash:body} 
              {stash:embed:partials:charter process="start"}
            {/stash:body}

          {/exp:stash:set_list}
          
          {stash:embed:partials:tabs stash:list="tabs_workgroup_body" stash:heading="View"}
          
        {/exp:playa:parents}
      {/case}

    {/exp:switchee}
    
	{/exp:stash:set}{!-- /layout_copy --}
	
  {exp:stash:set_list name="layout_meta_after" parse_conditionals="yes" parse_tags="yes" parse_depth="3"}

    {exp:switchee variable="stash:_type" parse="inward" match="all"}
      
      {case value="resource"}
        {!-- Outgoing --}
        {if entry_date < current_time && (cf-resource-t-url != "" || cf-resource-cv-videos != "")}
          {stash:name}Outgoing{/stash:name}
          {stash:slug}outgoing{/stash:slug}
          {stash:link}
            {if cf-resource-cv-videos}
              {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}{video:web_url}{/exp:channel_videos:videos}
            {if:else}
              {cf-resource-t-url}
            {/if}
          {/stash:link}
  
          {stash:text}
            {if cf-resource-t-url == "" && cf-resource-cv-videos == ""}
            Download
            {if:elseif channel_short_name == "resource_videos" || channel_short_name == "resource_presentations" }
              Watch now
            {if:elseif channel_short_name == "resource_podcasts"}
              Listen now										
            {if:else}
              Go
            {/if}
          {/stash:text}
        {/if}

        {!-- Resource: Presenters --}
        {if cf-resource-presenters}
          {cf-resource-presenters orderby="screen_name"}
            {if count == 1}
              {stash:name}Presenter{if total_results != 1}s{/if}{/stash:name}
              {stash:slug}presenters{/stash:slug}  
            {/if}
            {exp:stash:append_list:presenters name="layout_meta_after_presenters"}
              {stash:text}{screen_name}{/stash:text}
            {/exp:stash:append_list:presenters}
          {/cf-resource-presenters}
        {if:elseif author_id != 1 && channel_short_name == "resource_presentations"}
          {stash:name}Presenter{/stash:name}
          {stash:slug}presenters{/stash:slug}
          {stash:text}{author}{/stash:text}
        {/if}

        {!-- Resource: downloads --}
        {cf-resource-m-downloads var_prefix="download"}
          {if download:row_count == 1}
            {stash:name}Download{if download:total_rows > 1}s{/if}{/stash:name}
            {stash:slug}downloads{/stash:slug}
          {/if}

          {exp:stash:append_list:downloads name="layout_meta_after_downloads" parse_conditionals="yes" parse_tags="yes"}
            {stash:link}{download:upload_file}{/stash:link}
            {stash:text}
              {if download:upload_description}
                {download:upload_description}
              {if:else}
                Supporting document
              {/if}
            {/stash:text}
          {/exp:stash:append_list:downloads}
        {/cf-resource-m-downloads}

      {/case}
      
      {case value="blog"}
        {stash:name}Forum{/stash:name}
        {stash:slug}forum{/stash:slug}

        {if forum_topic}
          {stash:link}{path='forums/viewthread'}/{forum_topic_id}/{/stash:link}
          {stash:text}Discuss in the forums{/stash:text}
        {/if}
        {if not_forum_topic}
          {stash:link}
            {stash:nocache}
            {if logged_in}{path='/forums/newtopic/18/'}{if:else}/forums/member/login/{/if}
            {/stash:nocache}
          {/stash:link}
          {stash:text}
            {stash:nocache}
            {if logged_out}Log in and start{if:else}Start{/if} a discussion in the forums
            {/stash:nocache}
          {/stash:text}
        {/if}      
      {/case}
      
      {case value="workgroup"}
        {if cf-wg-new-wiki != "" || cf-wg-t-wghome != ""}
          {stash:name}Wiki{/stash:name}
          {stash:slug}wiki{/stash:slug}
          {stash:text}
            {if cf-wg-new-wiki == 'y'}
              At open-services.net
            {if:elseif cf-wg-t-wghome != ""}
              At {exp:parse_url parts="host"}{cf-wg-t-wghome}{/exp:parse_url}
            {/if}
          {/stash:text}
          {stash:link}
            {if cf-wg-new-wiki == 'y'}
              /wiki/{url_title}/
            {if:elseif cf-wg-t-wghome != ""}
              {cf-wg-t-wghome}
            {/if}
          {/stash:link}
  
        {/if}

        {!-- Workgroup: meetings --}
        {if cf-wg-t-meetings}
          {stash:name}Meetings{/stash:name}
          {stash:slug}meetings{/stash:slug}
          {stash:link}{cf-wg-t-meetings}{/stash:link}
          {stash:text}{if cf-wg-t-meetingtime}{cf-wg-t-meetingtime}{if:else}Schedule{/if}{/stash:text}
        {/if}

        {!-- Workgroup: mailing lists --}
        {if cf-wg-t-mailinglist && (segment_2_category_group_id != "4" || segment_2 == "communications")}
          {stash:name}Mailing list{/stash:name}
          {stash:slug}mailing-list{/stash:slug}
          {stash:link}{cf-wg-t-mailinglist}{/stash:link}
          {stash:text}At {exp:parse_url parts="host"}{cf-wg-t-mailinglist}{/exp:parse_url}{/stash:text}
        {/if}
        {if cf-wg-t-mailinglist && (segment_2_category_group_id == "4" && segment_2 != "communications")}
          {stash:name}Forum{/stash:name}
          {stash:slug}forum{/stash:slug}
          {stash:link}{cf-wg-t-mailinglist}{/stash:link}
          {stash:text}At open-services.net{/stash:text}
        {/if}

        {!-- Workgroup: lead/chair --}
        {cf-wg-m-leads var_prefix="leaders"}
          {if {leaders:row_count} == 1}
            {stash:name}{if oslc:workgroup:is_at_oasis}Chair{if:else}Workgroup lead{/if}{if leaders:total_rows > 1}s{/if}{/stash:name}
            {stash:slug}lead{/stash:slug}
          {/if}
  
          {exp:stash:append_list:leaders name="layout_meta_after_lead"}
            {stash:link}{path='forums/member/{leaders:lead}'}{/stash:link}
            {stash:text}{leaders:lead:names}{/stash:text}
          {/exp:stash:append_list:leaders}
  
        {/cf-wg-m-leads}
        
        {!-- Workgroup: specs --}
        {cf-wg-r-specs sort="desc" search:cf-spec-text="not IS_EMPTY" var_prefix="spec"}

          {if {spec:count} == 1}
            {stash:name}Specification{if {spec:total_results} > 1}s{/if}{/stash:name}
            {stash:slug}specifications{/stash:slug}
          {/if}

          {exp:stash:append_list:specifications name="layout_meta_after_specifications"}
            {stash:link}{spec:cf-spec-text}{/stash:link}
            {stash:text}{spec:title}{/stash:text}
            {stash:tag}{spec:cf-spec-pill-status}{/stash:tag}
          {/exp:stash:append_list:specifications}

        {/cf-wg-r-specs}
        
        {!-- Contributing organizations --}
        {exp:stash:get_list orderby="text" sort_type="lowercase" name="children" match="#company#" against="channel_slug" prefix="org"}
          {if {org:count} == 1}
            {stash:name}Contributing organizations{/stash:name}
            {stash:slug}contributing-organizations{/stash:slug}
          {/if}

          {exp:stash:append_list:orgs name="layout_meta_after_contributing-organizations"}
            {stash:link}{org:url}{/stash:link}
            {stash:text}{org:text}{/stash:text}
          {/exp:stash:append_list:orgs}
        {/exp:stash:get_list}

        {!-- Workgroup ancestry and replacements --}
        {exp:stash:get_list name="children" match="#workgroups#" against="channel_slug" prefix="replaced"}
          {if {replaced:count} == 1}
            {stash:name}Precursors{/stash:name}
            {stash:slug}ancestry{/stash:slug}
          {/if}
          {exp:stash:append_list:ancestry name="layout_meta_after_ancestry"}
            {stash:link}{replaced:url}{/stash:link}
            {stash:text}{replaced:text}{/stash:text}
          {/exp:stash:append_list:ancestry}
        {/exp:stash:get_list}

        {exp:stash:get_list name="parents" limit="1" match="#workgroups#" against="channel_slug" prefix="new_hotness"}
          {stash:name}Bit of a ghost town here{/stash:name}
          {stash:slug}ghost-town{/stash:slug}
          {stash:link}{new_hotness:url}{/stash:link}
          {stash:text}Active specification development now at {new_hotness:text}{/stash:text}
        {/exp:stash:get_list}
        
      {/case} {!-- /workgroup --}
      
    {/exp:switchee}

  {/exp:stash:set_list}
	
	{exp:switchee variable="stash:_type" parse="inward" match="all"}
	
	  {case value="blog|resource|workgroup"}
      
      {exp:stash:append name="layout_relationships" parse_depth="2" parse_tags="yes" match="#\S#"}
        {exp:loopee foreach="{stash:_children_relationships}" parse="inward" as="channel_slug"}
          {exp:stash:embed:partials:relationships
            stash:list="children"
            stash:against="channel_slug"
            stash:match="#{channel_slug}#"            
          }        
        {/exp:loopee}
        {exp:loopee foreach="{stash:_parents_relationships}" parse="inward" as="channel_slug"}
          {exp:stash:embed:partials:relationships
            stash:list="parents"
            stash:against="channel_slug"
            stash:match="#{channel_slug}#"            
          }        
        {/exp:loopee}
      {/exp:stash:append}	  
	  {/case}
	  
	  {case value="blog"}
      {exp:stash:set name="layout_deck_author"}{encode="{email}" title="{author}"}{/exp:stash:set}
	  {/case} {!-- /blog --}
	  
	  
	  {case value="resource"}
	    {!-- Mailing list for prezzies --}
      {exp:stash:append name="layout_copy" match="#resource_presentations#" against="{channel_short_name}"}
        {exp:stash:embed:partials:notice stash:notice_type="tip" stash:notice_body='    Want to receive an email when we announce more presentations? <a href="{structure:page_url_for:146}" class="btn">Sign up here!</a>'}
      {/exp:stash:append}
      
      {!-- Instructions for presentations --}
      {exp:stash:prepend name="layout_copy" match="#resource_presentations#" against="{channel_short_name}"}
        {if entry_date > current_time}
        {exp:stash:embed:partials:notice 
          stash:notice_type="warning" 
          stash:notice_title="Watch it live"
          stash:notice_body='{entry_date format="%Y %F %j @ %g:%i %A"}<p><a rel="external" href="{cf-resource-ta-location}" class="btn">Register</a></p><div>{exp:smartdown}{cf-resource-md-instructions}{/exp:smartdown}</div>'
          }
        {/if}
      {/exp:stash:prepend}
      
      {!-- Presentation flags --}
      {exp:stash:set_list name="layout_tags" parse_conditionals="yes"}
        {if entry_date > current_time}
          {stash:text}Upcoming{/stash:text}
          {stash:icon}tag-upcoming{/stash:icon}
          {stash:class}info{/stash:class}        
        {/if}
        {if expiration_date != "0" && expiration_date < current_time}
          {stash:text}Video coming soon{/stash:text}
          {stash:class}success{/stash:class}
        {/if}      
      {/exp:stash:set_list}
      
      {exp:stash:prepend_list name="layout_tags" parse_tags="yes"}
        {stash:text}{channel}{/stash:text}
        {stash:icon}channel-{exp:stringy:slug separator="-" case="lower"}{channel}{/exp:stringy:slug}{/stash:icon}
        {stash:href}{structure:parent:uri}{/stash:href}
      {/exp:stash:prepend_list}
	  
	  {/case} {!-- /resource --}
	  
	  
	  {case value="workgroup"}
	    
	    
	    
	  {/case}
	  
	{/exp:switchee}

{/exp:channel:entries}

{if {stash:_sequence}}
  {stash:embed:viewmodels:detail_sequence_simple}
{/if}

{exp:switchee variable="stash:_type" parse="inward" match="all"}
  
  {case value="workgroup"}
    {exp:stash:set_value name="layout_headtitle" value="{structure:page:title} Workgroup"}
  {/case}

  {!-- Tutorials require more data re: the overview topic and secondary menu --}
  {case value="tutorial"}
    {exp:channel:entries
      url_title="{segment_3}"
      limit="1"
      dynamic="off"}
      {!-- 
        Override headtitle to include the overview title 
        The match/against here will hit only for child pages (segment_4 not empty)
        http://stackoverflow.com/questions/4448829/regular-expression-for-not-empty
      --}
      {exp:stash:set name="layout_headtitle" match="#^(?=\s*\S).*$#" against="{segment_4}"}
        {structure:page:title} - {title}
      {/exp:stash:set}
      
      {exp:stash:set name="layout_secondary_nav_title"}{title}{/exp:stash:set}

    {/exp:channel:entries}
    
    {exp:stash:set name="layout_secondary_nav_short_title"}Tutorial{/exp:stash:set}
    
    {exp:stash:append name="layout_copy"}
      {exp:stash:embed:partials:notice 
        stash:notice_type="tip" 
        stash:notice_title="Any problems?"
        stash:notice_body='{lv-tutorialAnyProblems-en}' }
    {/exp:stash:append}
    
    {exp:stash:set name="layout_secondary_nav"}
      {exp:structure:nav
        start_from="/{segment_1}/{segment_2}/{segment_3}/" 
        show_depth="5"
        show_overview="yes" 
        rename_overview="{lv-tutoverviewtext-en}"
        recursive_overview="no"
        current_class="current"
        include_ul="no"
        has_children_class="yes"
      }
    {/exp:stash:set}
    
  {/case}

{/exp:switchee}

{exp:tag:tags 
  entry_id="{structure:page:entry_id}"
  websafe_separator="-"
  }
  
  {exp:stash:append_list name="layout_tags"}
    {stash:href}/tagged/{websafe_tag}{/stash:href}
    {stash:text}{tag}{/stash:text}
  {/exp:stash:append_list}  

{/exp:tag:tags}