{stash:embed:layouts:{stash:_layout}}

{exp:channel:entries
	entry_id="{structure:page:entry_id}"
	show_future_entries="yes"
  show_expired="yes"
	status="{stash:_status}"
  disable="{global:disable_default}"
  {if stash:_disable != ''}
    disable="{stash:_disable}"
  {/if}
  require_entry="yes"
  parse="inward"
}

	{if no_results}{redirect="404"}{/if}
	
	{!-- Capture all relationships in one pass --}
  {exp:playa:children parse="inward" var_prefix="child"}
    {exp:stash:append_list name="children"}
      {stash:channel_slug}{child:channel_short_name}{/stash:channel_slug}
      {stash:channel}{child:channel}{/stash:channel}
      {stash:url}{child:page_url}{/stash:url}
      {stash:text}{child:title}{/stash:text}
    {/exp:stash:append_list}
  {/exp:playa:children}

  {exp:playa:parents parse="inward" var_prefix="parent"}
    {exp:stash:append_list name="parents"}
      {stash:channel_slug}{parent:channel_short_name}{/stash:channel_slug}
      {stash:channel}{parent:channel}{/stash:channel}
      {stash:url}{parent:page_url}{/stash:url}
      {stash:text}{parent:title}{/stash:text}
    {/exp:stash:append_list}
  {/exp:playa:parents}
  
	
	{exp:stash:set name="layout_deck_date"}{entry_date format="{lv-blogdateformat}"}{/exp:stash:set}
	{exp:stash:set name="layout_deck_date_w3c"}{entry_date format="{DATE_W3C}"}{/exp:stash:set}
	
	{!-- Primary body content --}
	{exp:stash:set name="layout_copy" match="#\S#"}
    {!-- blog --}
	  {if cf-blog-w-body}{cf-blog-w-body}{/if}
	  
	  {!-- Resource --}
    {if cf-resource-cv-videos}
      {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
        {if video:service == "youtube"}
          {video:embed_code_hd}
        {if:else}
          {video:embed_code}
        {/if}										
      {/exp:channel_videos:videos}
    {if:elseif cf-resource-t-embed}
      {cf-resource-t-embed}
    {/if}
    
    {if cf-resource-w-desc == "" && cf-resource-cv-videos != ""}
      {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
        Description from {video:service}: {video:description}
      {/exp:channel_videos:videos}
    {if:else}
      {cf-resource-w-desc}
    {/if}
    
	{/exp:stash:set}{!-- /layout_copy --}
	
	{exp:switchee variable="stash:_type" parse="inward" match="all"}
	
	  {case value="blog|resource"}
      {exp:stash:set_list name="layout_meta_after" parse_conditionals="yes" parse_tags="yes"}
        
        {!-- Resource: outgoing --}
				{if entry_date < current_time && (cf-resource-t-url != "" || cf-resource-cv-videos != "")}
				  {stash:name}Outgoing{/stash:name}
				  {stash:slug}outgoing{/stash:slug}
				  {stash:link}
            {if cf-resource-cv-videos}
              {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}{video:web_url}{/exp:channel_videos:videos}
            {if:else}
              {cf-resource-t-url}
            {/if}
				  {/stash:link}
				  
				  {stash:text}
				    {if cf-resource-t-url == "" && cf-resource-cv-videos == ""}
						Download
            {if:elseif channel_short_name == "resource_videos" || channel_short_name == "resource_presentations" }
              Watch now
            {if:elseif channel_short_name == "resource_podcasts"}
              Listen now										
            {if:else}
              Go
            {/if}
				  {/stash:text}
				  
				{/if}

        {if channel_short_name == "blog"}
          {stash:name}Forum{/stash:name}
          {stash:slug}forum{/stash:slug}

          {if forum_topic}
            {stash:link}{path='forums/viewthread'}/{forum_topic_id}/{/stash:link}
            {stash:text}Discuss in the forums{/stash:text}
          {/if}
          {if not_forum_topic}
            {stash:link}
              {stash:nocache}
              {if logged_in}{path='/forums/newtopic/18/'}{if:else}/forums/member/login/{/if}
              {/stash:nocache}
            {/stash:link}
            {stash:text}
              {stash:nocache}
              {if logged_out}Log in and start{if:else}Start{/if} a discussion in the forums
              {/stash:nocache}
            {/stash:text}
          {/if}
        {/if}
        
        {!-- Resource: Presenters --}
        {if cf-resource-presenters}
          {cf-resource-presenters orderby="screen_name"}
            {if count == 1}
              {stash:name}Presenter{if total_results != 1}s{/if}{/stash:name}
              {stash:slug}presenters{/stash:slug}  
            {/if}
            {exp:stash:append_list:presenters name="layout_meta_after_presenters"}
              {stash:text}{screen_name}{/stash:text}
            {/exp:stash:append_list:presenters}
          {/cf-resource-presenters}
        {if:elseif author_id != 1 && channel_short_name == "resource_presentations"}
          {stash:name}Presenter{/stash:name}
          {stash:slug}presenters{/stash:slug}
          {stash:text}{author}{/stash:text}
        {/if}

        {!-- Resource: downloads --}
        {cf-resource-m-downloads var_prefix="download"}
          {if download:row_count == 1}
            {stash:name}Download{if download:total_rows > 1}s{/if}{/stash:name}
            {stash:slug}downloads{/stash:slug}
          {/if}

          {exp:stash:append_list:downloads name="layout_meta_after_downloads" parse_conditionals="yes" parse_tags="yes"}
            {stash:link}{download:upload_file}{/stash:link}
            {stash:text}
              {if download:upload_description}
                {download:upload_description}
              {if:else}
                Supporting document
              {/if}
            {/stash:text}
          {/exp:stash:append_list:downloads}
        {/cf-resource-m-downloads}
				
      {/exp:stash:set_list}
      
      {exp:stash:append name="layout_relationships" parse_depth="2" parse_tags="yes" match="#\S#"}
        {exp:loopee foreach="{stash:_children_relationships}" parse="inward" as="channel_slug"}
          {exp:stash:embed:partials:relationships
            stash:list="children"
            stash:against="channel_slug"
            stash:match="#{channel_slug}#"            
          }        
        {/exp:loopee}
        {exp:loopee foreach="{stash:_parents_relationships}" parse="inward" as="channel_slug"}
          {exp:stash:embed:partials:relationships
            stash:list="parents"
            stash:against="channel_slug"
            stash:match="#{channel_slug}#"            
          }        
        {/exp:loopee}
      {/exp:stash:append}	  
	  {/case}
	  
	  {case value="blog"}
      {exp:stash:set name="layout_deck_author"}{encode="{email}" title="{author}"}{/exp:stash:set}
	  {/case} {!-- /blog --}
	  
	  
	  {case value="resource"}
	    {!-- Mailing list for prezzies --}
      {exp:stash:append name="layout_copy" match="#resource_presentations#" against="{channel_short_name}"}
        {exp:stash:embed:partials:notice stash:notice_type="tip" stash:notice_body='    Want to receive an email when we announce more presentations? <a href="{structure:page_url_for:146}" class="btn">Sign up here!</a>'}
      {/exp:stash:append}
      
      {!-- Instructions for presentations --}
      {exp:stash:prepend name="layout_copy" match="#resource_presentations#" against="{channel_short_name}"}
        {if entry_date > current_time}
        {exp:stash:embed:partials:notice 
          stash:notice_type="warning" 
          stash:notice_title="Watch it live"
          stash:notice_body='{entry_date format="%Y %F %j @ %g:%i %A"}<p><a rel="external" href="{cf-resource-ta-location}" class="btn">Register</a></p><div>{exp:smartdown}{cf-resource-md-instructions}{/exp:smartdown}</div>'
          }
        {/if}
      {/exp:stash:prepend}
      
      {!-- Presentation flags --}
      {exp:stash:set_list name="layout_tags" parse_conditionals="yes"}
        {if entry_date > current_time}
          {stash:text}Upcoming{/stash:text}
          {stash:icon}tag-upcoming{/stash:icon}
          {stash:class}info{/stash:class}        
        {/if}
        {if expiration_date != "0" && expiration_date < current_time}
          {stash:text}Video coming soon{/stash:text}
          {stash:class}success{/stash:class}
        {/if}      
      {/exp:stash:set_list}
      
      {exp:stash:prepend_list name="layout_tags" parse_tags="yes"}
        {stash:text}{channel}{/stash:text}
        {stash:icon}channel-{exp:stringy:slug separator="-" case="lower"}{channel}{/exp:stringy:slug}{/stash:icon}
        {stash:href}{structure:parent:uri}{/stash:href}
      {/exp:stash:prepend_list}
	  {/case}
	  
	{/exp:switchee}

{/exp:channel:entries}

{if {stash:_sequence}}
  {stash:embed:viewmodels:detail_sequence_simple}
{/if}

{exp:tag:tags 
  entry_id="{structure:page:entry_id}"
  websafe_separator="-"
  }
  
  {exp:stash:append_list name="layout_tags"}
    {stash:href}/tagged/{websafe_tag}{/stash:href}
    {stash:text}{tag}{/stash:text}
  {/exp:stash:append_list}  

{/exp:tag:tags}