{stash:embed context="layouts" name="{stash:_layout}"}

{exp:channel:entries
	require_entry="yes"
	status="{stash:_status}"
	{global:disable_default}
}

	{!-- If Structure/Channel modules can't find an entry, 404 it --}
	{if no_results}{redirect="404"}{/if}

  
  {!-- Capture all relationships in one pass --}
  {exp:playa:children parse="inward" var_prefix="child"}
    {exp:stash:append_list name="children"}
      {stash:channel_slug}{child:channel_short_name}{/stash:channel_slug}
      {stash:channel}{child:channel}{/stash:channel}
      {stash:url}{child:page_url}{/stash:url}
      {stash:text}{child:title}{/stash:text}
    {/exp:stash:append_list}
  {/exp:playa:children}

  {exp:playa:parents parse="inward" var_prefix="parent"}
    {exp:stash:append_list name="parents"}
      {stash:channel_slug}{parent:channel_short_name}{/stash:channel_slug}
      {stash:channel}{parent:channel}{/stash:channel}
      {stash:url}{parent:page_url}{/stash:url}
      {stash:text}{parent:title}{/stash:text}
    {/exp:stash:append_list}
  {/exp:playa:children}
  
	
	{exp:stash:set name="layout_deck_date"}{entry_date format="{lv-blogdateformat}"}{/exp:stash:set}
	{exp:stash:set name="layout_deck_date_w3c"}{entry_date format="{DATE_W3C}"}{/exp:stash:set}
	{exp:stash:set name="layout_deck_author"}{encode="{email}" title="{author}"}{/exp:stash:set}
	
	{exp:switchee variable="{stash:_type}" parse="inward"}
	
	  {case value="blog"}
	    {exp:stash:set name="layout_copy"}{cf-blog-w-body}{/exp:stash:set}
	    
      {exp:stash:append_list name="layout_meta_after" parse_conditionals="yes"}
        {stash:name}Forum{/stash:name}
        {stash:slug}forum{/stash:slug}

        {if forum_topic}
          {stash:link}{path='forums/viewthread'}/{forum_topic_id}/{/stash:link}
          {stash:text}Discuss in the forums{/stash:text}
        {/if}
        
        {if not_forum_topic}
          {stash:link}{if logged_in}{path='/forums/newtopic/18/'}{if:else}/forums/member/login/{/if}{/stash:link}
          {stash:text}{if logged_out}Log in and start{if:else}Start{/if} a discussion in the forums{/stash:text}
        {/if}
        
      {/exp:stash:append_list}
      
      {exp:stash:append name="layout_relationships"}
      
        {exp:stash:embed:partials:relationships 
          stash:list="children"
          stash:match="#workgroups#"
          stash:against="channel_slug"
        }
        
        {exp:stash:embed:partials:relationships
          stash:list="children"
          stash:match="#company#"
          stash:against="channel_slug"
        }
        
      {/exp:stash:append}
      
	  {/case} {!-- /blog --}
	
	{/exp:switchee}

{/exp:channel:entries}

{exp:tag:tags 
  entry_id="{structure:page:entry_id}"
  websafe_separator="-"
  }
  
  {exp:stash:append_list name="layout_tags"}
    {stash:href}/blog/tag/{websafe_tag}{/stash:href}
    {stash:text}{tag}{/stash:text}
  {/exp:stash:append_list}  

{/exp:tag:tags}