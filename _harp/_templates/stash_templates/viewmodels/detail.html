{stash:embed:layouts:{stash:_layout}}

{exp:channel:entries
	entry_id="{structure:page:entry_id}"
	dynamic="no"
  parse="inward"
	show_future_entries="yes"
  show_expired="yes"
	status="{stash:_status}"
  disable="{global:disable_default}"
  {if stash:_disable != ''}
    disable="{stash:_disable}"
  {/if}
  require_entry="yes"
}

	{if no_results}{redirect="404"}{/if}
	
	{!-- Capture all relationships in one pass --}
	{exp:stash:parse parse_depth="2"}
    {exp:playa:children parse="inward" var_prefix="child"}
      {exp:stash:append_list name="children"}
        {stash:channel_slug}{child:channel_short_name}{/stash:channel_slug}
        {stash:channel}{child:channel}{/stash:channel}
        {stash:url}{child:page_url}{/stash:url}
        {stash:text}{child:title}{/stash:text}
      {/exp:stash:append_list}
    {/exp:playa:children}

    {exp:playa:parents parse="inward" var_prefix="parent"}
      {exp:stash:append_list name="parents"}
        {stash:channel_slug}{parent:channel_short_name}{/stash:channel_slug}
        {stash:channel}{parent:channel}{/stash:channel}
        {stash:url}{parent:page_url}{/stash:url}
        {stash:text}{parent:title}{/stash:text}
      {/exp:stash:append_list}
    {/exp:playa:parents}
  {/exp:stash:parse}
  
  	
	{!-- Primary body content --}
	{exp:stash:set name="layout_copy" match="#\S#"}
    {exp:switchee variable="stash:_type" parse="inward"}
    
      {case value="blog"}
        {cf-blog-w-body}
      {/case}
    
      {case value="resource"}
        {if cf-resource-cv-videos}
          {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
            {if video:service == "youtube"}
              {video:embed_code_hd}
            {if:else}
              {video:embed_code}
            {/if}										
          {/exp:channel_videos:videos}
        {if:elseif cf-resource-t-embed}
          {cf-resource-t-embed}
        {/if}
      
        {if cf-resource-w-desc == "" && cf-resource-cv-videos != ""}
          {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
            Description from {video:service}: {video:description}
          {/exp:channel_videos:videos}
        {if:else}
          {cf-resource-w-desc}
        {/if}
      {/case}
        
      {case value="tutorial"}
        {if cf-tut-w-body}
          {if cf-tut-m-altversions} 
            <p>(<i>Download as {cf-tut-m-altversions}{if row_count > 1 && total_rows == 2}&nbsp;or&nbsp;{/if}<a href="{altfile}">{altdescription}</a>{if row_count != total_rows && total_rows != 2},{/if}{/cf-tut-m-altversions}.</i>)</p>
          {/if}
          {cf-tut-w-body}
        {/if}
        {if cf-tutpage-w-body}{cf-tutpage-w-body}{/if}
      {/case}

      {case value="workgroup"}
        {exp:playa:parents channel="charters" field="cf-wgcharter-r-workgroup" status="open" limit="1" var_prefix="charter"}
          {!-- No charter? Just show the description --}
          {if no_parents}{cf-wg-w-description-en}{/if}
          
          {exp:stash:set_list name="tabs_workgroup_body"}
            {stash:label}Description{/stash:label}
            {stash:id}description{/stash:id}
            {stash:body}{cf-wg-w-description-en}{/stash:body}
            
            {stash:label}Charter{/stash:label}
            {stash:id}charter{/stash:id}
            {stash:body} 
              {stash:embed:partials:charter process="start" parse="no"}
            {/stash:body}

          {/exp:stash:set_list}
          
          {stash:embed:partials:tabs stash:list="tabs_workgroup_body" stash:heading="View"}
          
        {/exp:playa:parents}
      {/case}
      
      {case value="software"}
        {stash:embed:viewmodels:copy:software process="start" parse="no"}
      {/case}

    {/exp:switchee}
    
	{/exp:stash:set}{!-- /layout_copy --}
	
	{exp:stash:set_list name="layout_meta_before" parse_conditionals="yes" parse_tags="yes" parse_depth="3"}
	  {exp:switchee variable="stash:_type" parse="inward"}
	    {case value="software"}
	      {cf-pr-m-consumes-en var_prefix="consumes"}
	        {if consumes:row_count == 1}
	          {stash:name}Consumes{/stash:name}
            {stash:slug}consumes{/stash:slug}
	        {/if}

	        {consumes:spec var_prefix="consumed_spec"}
            {exp:stash:append_list:consumed name="layout_meta_before_consumes"}
              {stash:link}{consumed_spec:cf-spec-text}{/stash:link}
              {stash:text}{consumed_spec:title}{/stash:text}
            {/exp:stash:append_list:consumed}
          {/consumes:spec}
	      {/cf-pr-m-consumes-en}
	      
	      {cf-pr-m-produces-en var_prefix="produces"}
	        {if produces:row_count == 1}
	          {stash:name}Produces{/stash:name}
            {stash:slug}produces{/stash:slug}
	        {/if}
	        
          {exp:stash:set_list:produced name="layout_meta_before_produces" parse_tags="yes" parse_depth="2" parse_conditionals="yes"}
            {produces:produces var_prefix="produced_spec"} {!-- lol shame on me --}
              {stash:link}{produced_spec:cf-spec-text}{/stash:link}
              {stash:text}{produced_spec:title}{if produces:via_adapter}*{/if}{/stash:text}            
            {/produces:produces}
            {if produces:via_adapter}
              {stash:tooltip}
                Requires an adapter:
                {produces:via_adapter var_prefix="adapter" backspace="2"}{adapter:title}, {/produces:via_adapter}
              {/stash:tooltip}
            {/if}
          {/exp:stash:set_list:produced}

	      {/cf-pr-m-produces-en}

	      {if cf-pr-r-company}
          {stash:name}Organization{/stash:name}
          {stash:slug}organization{/stash:slug}
          {cf-pr-r-company var_prefix="org"}
            {stash:link}{org:cf-co-t-url}{/stash:link}
            {stash:text}{org:title}{/stash:text}
          {/cf-pr-r-company}
	      {/if}

        {if cf-pr-t-produrl}
          {stash:name}Outgoing{/stash:name}
          {stash:slug}outgoing{/stash:slug}
          {stash:link}{cf-pr-t-produrl}{/stash:link}
          {stash:text}Learn more at {exp:parse_url parts="host" omit="www.|www-01.|www8.|msdn."}{cf-pr-t-produrl}{/exp:parse_url}{/stash:text}
        {/if}

	    {/case}
	  {/exp:switchee}
	{/exp:stash:set_list}
		
  {exp:stash:set_list name="layout_meta_after" parse_conditionals="yes" parse_tags="yes" parse_depth="3"}

    {exp:switchee variable="stash:_type" parse="inward" match="all"}
      
      {case value="blog"}
        {stash:name}Forum{/stash:name}
        {stash:slug}forum{/stash:slug}
        
        {stash:link}
        {if forum_topic}
          {path='forums/viewthread'}/{forum_topic_id}/
        {if:else}
          {stash:nocache}
          {if logged_in}
            {path='/forums/newtopic/18/'}
          {if:else}
            /forums/member/login/
          {/if}
          {/stash:nocache}
        {/if}
        {/stash:link}

        {stash:text}
        {if forum_topic}
          Discuss in the forums
        {if:else}
          {stash:nocache}
          {if logged_out}Log in and start{if:else}Start{/if} a discussion in the forums
          {/stash:nocache}
        {/if}
        {/stash:text}
      {/case}
      
      {case value="resource"}
        {stash:embed:viewmodels:meta_after:resource process="start" parse="no"}
      {/case}
            
      {case value="workgroup"}
        {stash:embed:viewmodels:meta_after:workgroup process="start" parse="no"}        
      {/case} {!-- /workgroup --}
      
    {/exp:switchee}

  {/exp:stash:set_list}
	
	{exp:switchee variable="stash:_type" parse="inward" match="all"}
	
	  {case value="blog|resource"}
      {exp:stash:set name="layout_deck_date"}{entry_date format="{lv-blogdateformat}"}{/exp:stash:set}
      {exp:stash:set name="layout_deck_date_w3c"}{entry_date format="{DATE_W3C}"}{/exp:stash:set}
	  {/case}
	  
	  {case value="blog|resource|workgroup|software"}
      
      {exp:stash:append name="layout_relationships" parse_depth="2" parse_tags="yes" match="#\S#"}
        {exp:loopee foreach="{stash:_children_relationships}" parse="inward" as="channel_slug"}
          {exp:stash:embed:partials:relationships
            stash:list="children"
            stash:against="channel_slug"
            stash:match="#{channel_slug}#"            
          }        
        {/exp:loopee}
        {exp:loopee foreach="{stash:_parents_relationships}" parse="inward" as="channel_slug"}
          {exp:stash:embed:partials:relationships
            stash:list="parents"
            stash:against="channel_slug"
            stash:match="#{channel_slug}#"            
          }        
        {/exp:loopee}
      {/exp:stash:append}	  
	  {/case}
	  
	  {case value="blog"}
      {exp:stash:set name="layout_deck_author"}{encode="{email}" title="{author}"}{/exp:stash:set}
	  {/case} {!-- /blog --}
	  
	  
	  {case value="resource"}
	    {!-- Mailing list for prezzies --}
      {exp:stash:append name="layout_copy" match="#resource_presentations#" against="{channel_short_name}"}
        {exp:stash:embed:partials:notice stash:notice_type="tip" stash:notice_body='    Want to receive an email when we announce more presentations? <a href="{structure:page_url_for:146}" class="btn">Sign up here!</a>'}
      {/exp:stash:append}
      
      {!-- Instructions for presentations --}
      {exp:stash:prepend name="layout_copy" match="#resource_presentations#" against="{channel_short_name}"}
        {if entry_date > current_time}
        {exp:stash:embed:partials:notice 
          stash:notice_type="warning" 
          stash:notice_title="Watch it live"
          stash:notice_body='{entry_date format="%Y %F %j @ %g:%i %A"}<p><a rel="external" href="{cf-resource-ta-location}" class="btn">Register</a></p><div>{exp:smartdown}{cf-resource-md-instructions}{/exp:smartdown}</div>'
          }
        {/if}
      {/exp:stash:prepend}
      
      {!-- Presentation flags --}
      {exp:stash:set_list name="layout_tags" parse_conditionals="yes"}
        {if entry_date > current_time}
          {stash:text}Upcoming{/stash:text}
          {stash:icon}tag-upcoming{/stash:icon}
          {stash:class}info{/stash:class}        
        {/if}
        {if expiration_date != "0" && expiration_date < current_time}
          {stash:text}Video coming soon{/stash:text}
          {stash:class}success{/stash:class}
        {/if}      
      {/exp:stash:set_list}
      
      {exp:stash:prepend_list name="layout_tags" parse_tags="yes"}
        {stash:text}{channel}{/stash:text}
        {stash:icon}channel-{exp:stringy:slug separator="-" case="lower"}{channel}{/exp:stringy:slug}{/stash:icon}
        {stash:href}{structure:parent:uri}{/stash:href}
      {/exp:stash:prepend_list}
	  
	  {/case} {!-- /resource --}
	  
	  
	  {case value="workgroup"}
	    {exp:stash:append name="layout_copy"}
	      {stash:nocache}
        {stash:embed context="viewmodels:copy" name="workgroup" parse_stage="both" process="start"}
        {/stash:nocache}
	    {/exp:stash:append}
	  {/case}
	  
	  {case value="software"}
	  {/case}
	  
	{/exp:switchee}

{/exp:channel:entries}

{if {stash:_sequence}}
  {stash:embed:viewmodels:detail_sequence_simple}
{/if}

{exp:switchee variable="stash:_type" parse="inward" match="all"}
  
  {case value="workgroup"}
    {exp:stash:set_value name="layout_headtitle" value="{structure:page:title} Workgroup"}
  {/case}

  {!-- Tutorials require more data re: the overview topic and secondary menu --}
  {case value="tutorial"}
    {exp:channel:entries
      url_title="{segment_3}"
      limit="1"
      dynamic="off"}
      {!-- 
        Override headtitle to include the overview title 
        The match/against here will hit only for child pages (segment_4 not empty)
        http://stackoverflow.com/questions/4448829/regular-expression-for-not-empty
      --}
      {exp:stash:set name="layout_headtitle" match="#^(?=\s*\S).*$#" against="{segment_4}"}
        {structure:page:title} - {title}
      {/exp:stash:set}
      
      {exp:stash:set name="layout_secondary_nav_title"}{title}{/exp:stash:set}

    {/exp:channel:entries}
    
    {exp:stash:set name="layout_secondary_nav_short_title"}Tutorial{/exp:stash:set}
    
    {exp:stash:append name="layout_copy"}
      {exp:stash:embed:partials:notice 
        stash:notice_type="tip" 
        stash:notice_title="Any problems?"
        stash:notice_body='{lv-tutorialAnyProblems-en}' }
    {/exp:stash:append}
    
    {exp:stash:set name="layout_secondary_nav"}
      {exp:structure:nav
        start_from="/{segment_1}/{segment_2}/{segment_3}/" 
        show_depth="5"
        show_overview="yes" 
        rename_overview="{lv-tutoverviewtext-en}"
        recursive_overview="no"
        current_class="current"
        include_ul="no"
        has_children_class="yes"
      }
    {/exp:stash:set}
    
  {/case}

{/exp:switchee}

{exp:tag:tags 
  entry_id="{structure:page:entry_id}"
  websafe_separator="-"
  }
  
  {exp:stash:append_list name="layout_tags"}
    {stash:href}/tagged/{websafe_tag}/{/stash:href}
    {stash:text}{tag}{/stash:text}
  {/exp:stash:append_list}  

{/exp:tag:tags}