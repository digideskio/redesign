{stash:embed:layouts:{stash:_layout} priority="1"}

{stash:embed:models:related_children process="inline" parse="yes"}
{stash:embed:models:related_parents process="inline" parse="yes"}

{exp:channel:entries
	entry_id="{structure:page:entry_id}"
	dynamic="no"
	show_future_entries="yes"
  show_expired="yes"
	status="open|closed"
  disable="categories|pagination"
  require_entry="yes"
}

  {if no_results}{redirect="404"}{/if}
    
  {stash:embed:models:detail_dates process="start" parse="no"}
  
  {exp:stash:set_list name="layout_tags" parse_tags="yes" parse_conditionals="yes"}
    {stash:text}{channel}{/stash:text}
    {stash:icon}channel-{exp:stringy:slug separator="-" case="lower"}{channel}{/exp:stringy:slug}{/stash:icon}
    {stash:href}{structure:parent:uri}{/stash:href}
    
    {if entry_date > current_time}
      {stash:text}Upcoming{/stash:text}
      {stash:icon}tag-upcoming{/stash:icon}
      {stash:class}info{/stash:class}        
    {/if}
    {if expiration_date != "0" && expiration_date < current_time}
      {stash:text}Video coming soon{/stash:text}
      {stash:class}success{/stash:class}
    {/if}      

  {/exp:stash:set_list}

  {exp:stash:set name="layout_copy" match="#\S#"}
    {if channel_short_name == "resource_presentations"}
      {if entry_date > current_time}
        {exp:stash:embed:partials:notice 
          stash:notice_type="warning" 
          stash:notice_title="Watch it live"
          stash:notice_body='
          {entry_date format="%Y %F %j @ %g:%i %A"}<p><a rel="external" href="{cf-resource-ta-location}" class="btn">Register</a></p>
          
          <div>{exp:smartdown}{cf-resource-md-instructions}{/exp:smartdown}</div>
          '
          }
      {/if}
    {/if}
    
    {if cf-resource-cv-videos}
      {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
        {if video:service == "youtube"}
          {video:embed_code_hd}
        {if:else}
          {video:embed_code}
        {/if}										
      {/exp:channel_videos:videos}
    {if:elseif cf-resource-t-embed}
      {cf-resource-t-embed}
    {/if}
  
    {if cf-resource-w-desc == "" && cf-resource-cv-videos != ""}
      {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
        Description from {video:service}: {video:description}
      {/exp:channel_videos:videos}
    {if:else}
      {cf-resource-w-desc}
    {/if}
    
    {if channel_short_name == "resource_presentations"}
      {exp:stash:embed:partials:notice stash:notice_type="tip" stash:notice_body='Want to receive an email when we announce more presentations? <a href="{structure:page_url_for:146}" class="btn">Sign up here!</a>'}
    {/if}

  {/exp:stash:set}
  
  {exp:stash:set_list name="layout_meta_after" parse_conditionals="yes" parse_tags="yes"}
    {!-- Outgoing --}
    {if entry_date < current_time && (cf-resource-t-url != "" || cf-resource-cv-videos != "")}
      {stash:name}Outgoing{/stash:name}
      {stash:slug}outgoing{/stash:slug}
      {stash:link}
        {if cf-resource-cv-videos}
          {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}{video:web_url}{/exp:channel_videos:videos}
        {if:else}
          {cf-resource-t-url}
        {/if}
      {/stash:link}

      {stash:text}
        {if cf-resource-t-url == "" && cf-resource-cv-videos == ""}
        Download
        {if:elseif channel_short_name == "resource_videos" || channel_short_name == "resource_presentations" }
          Watch now
        {if:elseif channel_short_name == "resource_podcasts"}
          Listen now										
        {if:else}
          Go
        {/if}
      {/stash:text}
    {/if}

    {!-- Resource: Presenters --}
    {if cf-resource-presenters}
      {cf-resource-presenters orderby="screen_name"}
        {if count == 1}
          {stash:name}Presenter{if total_results != 1}s{/if}{/stash:name}
          {stash:slug}presenters{/stash:slug}  
        {/if}
        {exp:stash:append_list:presenters name="layout_meta_after_presenters"}
          {stash:text}{screen_name}{/stash:text}
        {/exp:stash:append_list:presenters}
      {/cf-resource-presenters}
    {if:elseif author_id != 1 && channel_short_name == "resource_presentations"}
      {stash:name}Presenter{/stash:name}
      {stash:slug}presenters{/stash:slug}
      {stash:text}{author}{/stash:text}
    {/if}

    {!-- Resource: downloads --}
    {cf-resource-m-downloads var_prefix="download"}
      {if download:row_count == 1}
        {stash:name}Download{if download:total_rows > 1}s{/if}{/stash:name}
        {stash:slug}downloads{/stash:slug}
      {/if}

      {exp:stash:append_list:downloads name="layout_meta_after_downloads" parse_conditionals="yes" parse_tags="yes"}
        {stash:link}{download:upload_file}{/stash:link}
        {stash:text}
          {if download:upload_description}
            {download:upload_description}
          {if:else}
            Supporting document
          {/if}
        {/stash:text}
      {/exp:stash:append_list:downloads}
    {/cf-resource-m-downloads}
  
  {/exp:stash:set_list}
  
{/exp:channel:entries}

{stash:embed:partials:relationships process="end"}

{stash:embed:viewmodels:detail_sequence_simple}