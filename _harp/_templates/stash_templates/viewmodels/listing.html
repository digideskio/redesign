{stash:embed:layouts:{stash:_layout}}

{exp:switchee variable="stash:_listing_style" parse="inward"}
  {case value="cards"}
    {exp:stash:extend name="layout_listing" with="partials:listing_cards"}
    {exp:stash:extend name="layout_bartender" with="partials:bartender"}
  {/case}
  
  {case value="simple"}
    {exp:stash:extend name="layout_copy" with="partials:listing_simple"}
  {/case}
{/exp:switchee}

{exp:switchee variable="stash:_type" parse="inward"}
  {case value="tagged"}
    {exp:stash:set name="layout_headtitle"}
    All content tagged &ldquo;{exp:tag:tag_name websafe_separator="-"}{segment_2}{/exp:tag:tag_name}&rdquo;
    {/exp:stash:set}
    {exp:stash:set name="layout_pagetitle"}
    All content tagged &ldquo;{exp:tag:tag_name websafe_separator="-"}{segment_2}{/exp:tag:tag_name}&rdquo;
    {/exp:stash:set}
    
    {exp:stash:set name="layout_listing_description" parse_tags="yes" match="#\S#"}
      {exp:low_variables:parse var="lv:tag_description" limit="1" search:name="{segment_2}"}
        {description}
      {/exp:low_variables:parse}
    {/exp:stash:set}
  {/case}
  
  {case value="workgroup|software"}
    {!-- Grab the listing description from the page's entry --}
    {exp:channel:entries
    	entry_id="{structure:page:entry_id}"
      status="open|closed"
      disable="{global:disable_default}"
      require_entry="yes"
    }
      {exp:stash:set name="layout_listing_description" parse_tags="yes" match="#\S#"}
        {cf-sp-w-body-en}
      {/exp:stash:set}
    {/exp:channel:entries}
  {/case}
{/exp:switchee}

{exp:channel:entries
  require_entry="yes"
  dynamic="off"
  parse="inward"
  
  {if structure:child_listing:short_name != ''}
    channel="{structure:child_listing:short_name}"
  {/if}
  {if structure:child_listing:short_name == ''}
    entry_id="{stash:_listing_ids}"
  {/if}
  
  {global:disable_default}
  {if stash:_disable != ''}
    disable="{stash:_disable}"
  {/if}
  
  limit="100"
  {if stash:_limit != ''}
    limit="{stash:_limit}"
    paginate="bottom"
  {/if}
  
  {stash:_listing_extra_params}
  
}
  {if no_results}{redirect="404"}{/if}
  
  {exp:stash:append_list name="listing" parse_tags="yes" parse_conditionals="yes" parse_depth="2"}
    {stash:channel_slug}{channel_short_name}{/stash:channel_slug}
    {stash:url}{page_url}{/stash:url}
    {stash:title}{title}{/stash:title}
    {stash:entry_id}{entry_id}{/stash:entry_id}
    {stash:hook}{channel_short_name}_{url_title}{/stash:hook}
    
    {stash:summary}
      {if cf-resource-cv-videos}
        {exp:channel_videos:videos entry_id="{entry_id}" limit="1"}
          <em>Description from {video:service}</em>: {video:description}
        {/exp:channel_videos:videos}
      {if:else}
        {cf-blog-w-summary}{!-- blog --}
        {cf-tut-w-description}{!-- tutorial --}
        {cf-resource-w-desc}{!-- most other resources --}
        {workgroup_micro-description}
      {/if}
    {/stash:summary}
    
    {exp:switchee variable="{channel_short_name}" parse="inward" match="all"}
      {case value="blog|resource_articles|resource_podcasts|resource_presentations|resource_videos|resource_whitepapers"}
        {stash:date}{entry_date format="{lv-blogdateformat}"}{/stash:date}
        {stash:date_w3c}{entry_date format="{DATE_W3C}"}{/stash:date_w3c}
        {stash:date_epoch}{entry_date format="%U"}{/stash:date_epoch}
      {/case}
      
      {case value="blog"}
        {stash:author_link}{encode="{email}" title="{author}"}{/stash:author_link}
        {stash:author}{author}{/stash:author}
      {/case}
      
      {case value="workgroups"}
        {exp:stash:set_list:orgs name="organization_{entry_id}" parse_tags="yes" parse_vars="yes" parse_depth="2"}
          {exp:tag:tags entry_id="{entry_id}" websafe_separator="-" tag_group_name="sdos"}
            {stash:href}/tagged/{websafe_tag}/{/stash:href}
            {stash:text}{tag}{/stash:text}
            {stash:filter}organization{/stash:filter}
          {/exp:tag:tags}
        {/exp:stash:set_list:orgs}
      {/case}
      
      {case value="products"}
        {stash:is_adapter}{cf-pr-s-isconnector}{/stash:is_adapter}
      {/case}
    {/exp:switchee}
    
    {exp:stash:set_list:tags name="tags_{entry_id}" parse_tags="yes" parse_conditionals="yes"}
      {if channel_short_name == "resource_presentations" && entry_date > current_time}
        {stash:text}Upcoming{/stash:text}
        {stash:icon}tag-upcoming{/stash:icon}
        {stash:class}info{/stash:class}        
      {/if}
      
      {if channel_short_name == "workgroups"}
        {exp:tag:tags entry_id="{entry_id}" websafe_separator="-" tag_group_name="workgroup_tags"}
          {stash:href}/tagged/{websafe_tag}/{/stash:href}
          {stash:text}{tag}{/stash:text}
          {stash:filter}tag{/stash:filter}
        {/exp:tag:tags}
      {/if}
      
    {/exp:stash:set_list:tags}
        
  {/exp:stash:append_list}
  
  {paginate}
    
    {pagination_links}
      {exp:stash:set name="layout_pagination_current"}{current_page}{/exp:stash:set}
      {exp:stash:set name="layout_pagination_total"}{total_pages}{/exp:stash:set}

      {previous_page}
        {exp:stash:set_value name="layout_prev_title" value="Newer posts"}
        {exp:stash:set name="layout_prev_url"}{pagination_url}{/exp:stash:set}
      {/previous_page}
      
      {next_page}
        {exp:stash:set_value name="layout_next_title" value="Older posts"}
        {exp:stash:set name="layout_next_url"}{pagination_url}{/exp:stash:set}
      {/next_page}      
    {/pagination_links}
    
  {/paginate}
  
{/exp:channel:entries}

{!-- Sign-up for presentations --}
{exp:stash:append name="layout_listing_description" match="#resource_presentations#" against="{structure:child_listing:short_name}"}
  {exp:stash:embed:partials:notice stash:notice_type="tip" stash:notice_body='    Want to receive an email when we announce more presentations? <a href="{structure:page_url_for:146}" class="btn">Sign up here!</a>'}
{/exp:stash:append}
