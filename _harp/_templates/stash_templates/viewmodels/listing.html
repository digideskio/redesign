{stash:embed:layouts:{stash:_layout}}

{exp:switchee variable="{stash:_listing_style}" parse="inward"}
  {case value="cards"}
    {exp:stash:extend name="layout_listing" with="partials:listing_cards"}
    {exp:stash:extend name="layout_bartender" with="partials:bartender"}
  {/case}
{/exp:switchee}

{exp:switchee variable="{stash:_type}" parse="inward"}
  {case value="tagged"}
    {exp:stash:set name="layout_headtitle"}
    All content tagged &ldquo;{exp:tag:tag_name websafe_separator="-"}{segment_2}{/exp:tag:tag_name}&rdquo;
    {/exp:stash:set}
    {exp:stash:set name="layout_pagetitle"}
    All content tagged &ldquo;{exp:tag:tag_name websafe_separator="-"}{segment_2}{/exp:tag:tag_name}&rdquo;
    {/exp:stash:set}
    
    {exp:stash:set name="layout_listing_description" parse_tags="yes" match="#\S#"}
      {exp:low_variables:parse var="lv:tag_description" limit="1" search:name="{segment_2}"}
        {description}
      {/exp:low_variables:parse}
    {/exp:stash:set}
  {/case}
{/exp:switchee}

{exp:channel:entries
  require_entry="yes"
  dynamic="off"
  
  {if structure:child_listing:short_name != ''}
    channel="{structure:child_listing:short_name}"
  {/if}
  {if structure:child_listing:short_name == ''}
    entry_id="{stash:_listing_ids}"
  {/if}
  
  disable="{global:disable_default}"
  {if stash:_disable != ''}
    disable="{stash:_disable}"
  {/if}
  
  limit="100"
  {if stash:_limit != ''}
    limit="{stash:_limit}"
    paginate="bottom"
  {/if}
  
}
  {if no_results}{redirect="404"}{/if}
  
  {exp:stash:append_list name="listing" parse_tags="yes" parse_conditionals="yes"}
    {stash:channel_slug}{channel_short_name}{/stash:channel_slug}
    {stash:url}{page_url}{/stash:url}
    {stash:title}{title}{/stash:title}
    
    {stash:date}{entry_date format="{lv-blogdateformat}"}{/stash:date}
    {stash:date_w3c}{entry_date format="{DATE_W3C}"}{/stash:date_w3c}
    {stash:date_epoch}{entry_date format="%U"}{/stash:date_epoch}
    
    {stash:author_link}{encode="{email}" title="{author}"}{/stash:author_link}
    {stash:author}{author}{/stash:author}
    
    {stash:summary}{cf-blog-w-summary}{/stash:summary}
  {/exp:stash:append_list}
  
  {paginate}
    
    {pagination_links}
      {previous_page}
        {exp:stash:set_value name="layout_prev_title" value="Newer posts"}
        {exp:stash:set name="layout_prev_url"}{pagination_url}{/exp:stash:set}
      {/previous_page}
      
      {next_page}
        {exp:stash:set_value name="layout_next_title" value="Older posts"}
        {exp:stash:set name="layout_next_url"}{pagination_url}{/exp:stash:set}
      {/next_page}
      
    {/pagination_links}
    
  {/paginate}
  
{/exp:channel:entries}