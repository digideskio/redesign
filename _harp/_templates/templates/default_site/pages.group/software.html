{stash:embed
  context="@URI"
  file_name="viewmodels:detail"
  parse_stage="both"
  stash:_type="software"
  stash:_layout="standard"
  stash:_status="open|closed"
  stash:_parents_relationships="blog|tutorial|resource_presentations|resource_videos|resource_articles|resource_whitepapers|resource_podcasts"
  
  stash:_one_last_script="{global:assets:js}softwareDiagram.min.js"
}

{!-- Store the specs (IDs) that this product supports
  You need this for two reasons:
    1: Match up all other products that support the same specs
    2: When listing the specs of the compatible product, limit the results to the specs supported by THIS product
--}
{exp:stash:parse}
  {exp:stash:set_value name="consumable_specs" parse="inward" value='{exp:playa:child_ids entry_id="{structure:page:entry_id}" field_id="21" col_id="15"}'}

  {exp:stash:set_value name="output_specs" parse="inward" value='{exp:playa:child_ids entry_id="{structure:page:entry_id}" field_id="22" col_id="17"}'}
{/exp:stash:parse}

{!-- COMPATIBLE PRODUCERS --}
{exp:switchee variable="stash:consumable_specs" parse="inward"}

  {!-- Only run this if you have IDs to pair up --}
  {case value="#^\d#"}
    {exp:playa:parents
      channel="products"
      parse="inward"
      child_id='{exp:stash:get name="consumable_specs"}'
      parent_id="not {structure:page:entry_id}" {!-- Exclude the requesting product from results --}
      field_id="22"
      col_id="17"
      orderby="title"
      sort="asc"
      search:cf-pr-s-isconnector="IS_EMPTY" {!-- Excludes adapter products --}
      var_prefix="provider"
    }
      {exp:stash:append_list name="compatible_providers"}
        {stash:title}{provider:title}{/stash:title}
        {stash:url}{provider:page_url}{/stash:url}
        {stash:entry_id}{provider:entry_id}{/stash:entry_id}
      {/exp:stash:append_list}

      {!-- Now fetch the MATCHING specs that the provider outputs --}
      {exp:playa:children 
        channel="specifications"
        parse="inward"
        child_id='{exp:stash:get name="consumable_specs"}'
        field_id="22"
        col_id="17"
        orderby="title"
        sort="asc"
        var_prefix="output_spec"}
    
        {exp:stash:append_list name="providers_specs" context="{provider:entry_id}"}
          {stash:title}{output_spec:title}{/stash:title}
          {stash:url}{output_spec:page_url}{/stash:url}
        {/exp:stash:append_list}
    
      {/exp:playa:children}

    {/exp:playa:parents}
  {/case}
{/exp:switchee}

{!-- COMPATIBLE CONSUMERS --}
{exp:switchee variable="stash:output_specs" parse="inward"}
  {case value="#^\d#"}
    {exp:playa:parents 
      channel="products"
      parse="inward"
      child_id='{exp:stash:get name="output_specs"}'
      parent_id="not {structure:page:entry_id}" {!-- Exclude the requesting product from results --}
      field_id="21"
      col_id="15"
      orderby="title"
      sort="asc"
      search:cf-pr-s-isconnector="IS_EMPTY" {!-- Excludes adapter products --}
      var_prefix="consumer"
    }

      {exp:stash:append_list name="compatible_consumers"}
        {stash:title}{consumer:title}{/stash:title}
        {stash:url}{consumer:page_url}{/stash:url}
        {stash:entry_id}{consumer:entry_id}{/stash:entry_id}
      {/exp:stash:append_list}
  
      {!-- Now fetch the MATCHING specs that the consumer can input --}
      {exp:playa:children
        channel="specifications"
        parse="inward"
        child_id='{exp:stash:get name="output_specs"}'
        field_id="21"
        col_id="15"
        orderby="title"
        sort="asc"
        var_prefix="consumed_spec"}
    
        {exp:stash:append_list name="consumers_specs" context="{consumer:entry_id}"}
          {stash:title}{consumed_spec:title}{/stash:title}
          {stash:url}{consumed_spec:page_url}{/stash:url}
        {/exp:stash:append_list}
    
      {/exp:playa:children}

    {/exp:playa:parents}
  {/case}
{/exp:switchee}




{exp:channel:entries entry_id="{structure:page:entry_id}" limit="1" dynamic='no'}

{exp:stash:set name="main_content"}
	
	
	<div class="line">
	
		<h2 class="h2 mtl mbn">

		{if cf-pr-s-isconnector != "y"}
			<a name="specs-compatibility"></a>Specifications &amp; Compatibility
		{if:else}
			Products &amp; Specifications
		{/if}
		</h2>		
		
		{!-- Consumers --}
		{if cf-pr-m-consumes-en && cf-pr-s-isconnector != "y"}
		<div class="unit {if cf-pr-m-produces-en}size1of2{if:else}size3of4{/if}">
		<div class="gutter">
			
			<h3 class="h3">Consumable specifications and compatible providers</h2>
			
			<p>{title} can <strong>consume</strong> resources in accordance with the following OSLC specifications:</p>
			
			<table class="table-basic">
				<thead>
				<tr>
					<th id="compatible-producers">Products that output the specification<a href="#compatibility-note"><sup><strong>*</strong></sup></a></th>
					<th id="outputspecs" style="width:40%;">Specification that {title} can consume (input)</th>					
				</tr>
				</thead>
			
				<tbody>
	
			
			{cf-pr-m-consumes-en}			
					<tr>
						<td headers="compatible-producers">
							{spec}				
								{exp:low_variables:single
									var="lv-compatible-products"
									preparse:spec_entry_id="{entry_id}"
									preparse:this_product_entry_id="{structure:page:entry_id}"
									preparse:matrix_field_id="22"
									preparse:matrix_row_id="17"
								}
							{/spec}
						</td>
						<td headers="outputspecs" class="spec-flow">
							
							{spec var_prefix="the_specification"}
								<a href="{the_specification:cf-spec-text}">{the_specification:title}</a>
							{/spec}
														
							{if via_adapter}
							<div class="box-inset mvm size3of4">
							(Requires an adapter: 
								{via_adapter backspace="2"}<a href="{page_url}">{title}</a>, {/via_adapter})
							</div>
							{/if}
						</td>
					</tr>	
			{/cf-pr-m-consumes-en}
				</tbody>
			</table>

		</div>	
		</div> {!-- /.unit --}
		{/if}		

		
		{!-- Producers --}
		{if cf-pr-m-produces-en && cf-pr-s-isconnector != "y" }
		<div class="unit {if cf-pr-m-consumes-en}lastUnit{if:else}size3of4{/if}">
	
			<h3 class="h3">Output specifications and compatible consumers</h2>
			
			<p>{title} can <strong>output</strong> resources in accordance with the following OSLC specifications:</p>
			
			<table class="table-basic">
				<thead>
				<tr>
					<th id="inputspecs" style="width:40%;">Specification that {title} can produce (output)</th>
					<th id="compatible-consumers">Products that consume the specification<a href="#compatibility-note"><sup><strong>*</strong></sup></a></th>
				</tr>
				</thead>
			
				<tbody>
			{cf-pr-m-produces-en}
					<tr>
						<td headers="inputspecs" class="spec-flow">
							{produces var_prefix="spec"}
								<a href="{spec:cf-spec-text}">{spec:title}</a>
							{/produces}
							{if via_adapter}
							<div class="box-inset mvm size3of4">
							(Requires an adapter: 
								{via_adapter backspace="2"}<a href="{page_url}">{title}</a>, {/via_adapter})
							</div>
							{/if}
						</td>
						<td headers="compatible-consumers">
							{produces}
								{exp:low_variables:single
									var="lv-compatible-products"
									preparse:spec_entry_id="{entry_id}"
									preparse:this_product_entry_id="{structure:page:entry_id}"
									preparse:matrix_field_id="21"
									preparse:matrix_row_id="15"
								}
							{/produces}
						</td>
					</tr>
			{/cf-pr-m-produces-en}
				</tbody>
			</table>
			
		</div>
		{/if}
				
		{!-- Adapters --}
		{if cf-pr-s-isconnector}
			
			{exp:playa:parents var_prefix="adapted" channel="products" }
			
				{if "{adapted:count}" == 1}
				<p>{title} adds the following capabilities to these products:</p>
				
				<table class="table-basic">
				<thead>
				<tr>
					{adapted:cf-pr-m-consumes-en search:via_adapter="{url_title}" limit="1"}
						{if row_count == 1}<th id="inputspecs">Gains support to <em>consume</em> (input) these specifications</th>{/if}
					{/adapted:cf-pr-m-consumes-en}

						<th>Name</th>
						
					{adapted:cf-pr-m-produces-en search:via_adapter="{url_title}" limit="1"}
						{if row_count == 1}<th id="outputspecs">Gains support to <em>produce</em> (output) these specifications</th>{/if}
					{/adapted:cf-pr-m-produces-en}
										
				</tr>
				</thead>
			
				<tbody>
				{/if}
				
				<tr>
					{!-- Products that can now consume a spec w/ adapter --}
					{!-- Limit specs returned to those where the adapter is in the via_adapter cell --}
					{adapted:cf-pr-m-consumes-en search:via_adapter="{url_title}"}
						{if row_count == 1}
						<td headers="inputspecs" class="spec-flow">
							<ul class="nobullets nospacing">
						{/if}
							<li class="mbs">{spec var_prefix="spec"}{spec:title}{/spec}</li>
						{if row_count == total_rows}
							</ul>
						</td>
						{/if}
					{/cf-pr-m-consumes-en}

					<td><a href="{adapted:page_url}">{adapted:title}</a></td>

					{!-- Products that can now output a spec w/ adapter --}
					{!-- Limit specs returned to those where the adapter is in the via_adapter cell --}
					{adapted:cf-pr-m-produces-en search:via_adapter="{url_title}"}
						{if row_count == 1}
						<td headers="outputspecs" class="spec-flow">
							<ul class="nobullets nospacing">
						{/if}
							<li class="mbs mln">{produces var_prefix="spec"}{spec:title}{/produces}</li>
						{if row_count == total_rows}
							</ul>
						</td>
						{/if}
					{/adapted:cf-pr-m-produces-en}
				</tr>
				
				{if "{adapted:count}" == "{adapted:total_results}"}
				</tbody>
				</table>
				{/if}
			
			{/exp:playa:parents}
			
		{/if}
	
	</div>{!-- /.line --}
	
	{if cf-pr-s-isconnector != "y"}
		<p class="callout-box">
			<a name="compatibility-note"></a>We make no guarantees about compliance with any specification. <a href="#specs-compatibility">Back to the compatibility table.</a>
		</p>
	{/if}

		
{/exp:stash:set}
	
{/exp:channel:entries}
	


