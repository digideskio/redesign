{!-- Single workgroup --}

{stash:embed
  context="@URI"
  file_name="viewmodels:detail"
  parse_stage="both"
  stash:_type="workgroup"
  stash:_layout="standard"
  stash:_status="open|closed"
  stash:_parents_relationships="blog|products|tutorials|resource_presentations|resource_videos|resource_articles|resource_whitepapers|resource_podcasts"
}


{!-- Need to move this out to prevent count variable conflicts --}
{exp:stash:set name="contributing_members"}
	{exp:stash:get_list name="workgroup_members"}
		{if count == 1}
			<div class="unit size1of2">
				<div class="gutter body-text">
					<h3 class="mtn">Contributing members</h3>
					
					{if logged_in && segment_2 != "steering-committee"}
						<div class="box-inset mbm">
							
							<p class="mts mvn">
							<strong>You</strong>: 
							{if oslc:user:is_workgroup_member}
								<span class="label success">Workgroup Member!</span>
								
								{if oslc:workgroup:is_user_group}
									<span id="swap_user_group_membership_placeholder"></span>
									<noscript>Activate JavaScript in your browser to leave the User Group</noscript>
								{/if}
								
							{if:elseif oslc:user:is_member}
								<span class="label notice">OSLC Member!</span>
								
								{if oslc:workgroup:is_user_group}
									<span id="swap_user_group_membership_placeholder"></span>
									<noscript>Activate JavaScript in your browser to join the User Group</noscript>
								{if:else}

								{/if}

							{if:else}

							{/if}
							</p>
						</div>
					{/if}


		{/if}
			
		
	{/exp:stash:get_list}
{/exp:stash:set}

{exp:stash:set name="main_content"}
		
	{exp:channel:entries entry_id="{structure:page:entry_id}" limit="1" {global:disable_default} }
	
		<div class="line mbl">
			
			{if workgroup_grid_misc-links}
			  <div class="unit lastUnit">
			    <div class="flag">
			    	<div class="flag-image">
			    	  <i title="Links" class="icon-font-strip-module-img icon-font-tinted mrs" data-icon="&#xe00a;"></i>
			    	</div>
			    	<div class="flag-body">
			    	  {workgroup_grid_misc-links}
			    	    <p class="mvn"><a href="{url}">{name}</a></p>
			    	  {/workgroup_grid_misc-links}
			    	</div>
			    </div>
			  </div>
			{/if}
			
		</div>{!-- .line.section-row --}

		{if workgroup_exernal-url}
      <div class="mvm">
      <a href="{workgroup_exernal-url}" class="button">
        At {exp:parse_url parts="host" omit="www."}{workgroup_exernal-url}{/exp:parse_url}
        <i data-icon="&#xe08d;"></i> 
      </a>
      </div>		
		{/if}
		
		<div class="section-row ptl">
		
			<ul role="tablist" class="line nav-tabs">
				<li class="nav-tab nav-tab-first active unit size1of3" role="decoration">
					<a id="tab1" role="tab" aria-controls="workgroup-members" href="#workgroup-members">Members</a>
				</li>
				
			</ul>
			
			<div class="tab-content">
				<div id="workgroup-members" class="tab-panel drop active in" role="tabpanel" aria-labelledby="tab1" data-tab="1">
					<h2 class="h2 onlynojs">Members</h2>
					
					
					
					<div class="line mts">
						
						{if cf-wg-new-wiki}
						
							{exp:stash:get name="contributing_members"}
						
						{/if}
						
					</div>
					
				</div>
				

			</div>
		</div>
	{/exp:channel:entries}
	
	{if logged_in_member_id > 0}
	
		{!-- Self-executing so as not to put it in the global scope --}
		<script>
			(function(){
				
				$(document).ready(function(){
				
					// Store some variables
					var cat_id = '{oslc:workgroup:category_id}',
						is_member = '{oslc:user:is_workgroup_member}',
						url = '{path="utilities/member_cats_form"}';

						// stick on a trailing slash
						url = url.replace(/\/?$/,'/');
					
					// insert form into memory
					$.ajax({
						url: url,
						success: function(data) {
							// get the form and appropriate input
							var $form = $('#member_categories_form', data),
								$input = $('input[value="' + cat_id + '"]', $form),
								memberships = [],
								current_cat_idx,
								$link,
								$placeholder = $('#swap_user_group_membership_placeholder');
							
							// find all existing memberships
							$form.find('input:checked').each(function(){
								memberships.push( $(this).val() );
							});
							
							// check if the current wg is part of them
							current_cat_idx = $.inArray( cat_id, memberships);
							
							// if so, remove that, as the current wg will change
							current_cat_idx > 0 && memberships.splice( current_cat_idx, 1 );

							// update the form's return value to the current page URL
							$('input[name="RET"]', $form).val(window.location.href);
							
							$form
								.addClass('hidden') // make sure the form stays hidden when inevitably inserted into DOM
								.css({'display': 'none', 'visibility' : 'hidden' })
								.on('submit', function(e){
									
									// validation
									// check that the list of *other* wgs has not changed
									
									var new_memberships = [],
										current_cat_idx,
										valid;
									
									$form.find('input:checked').each(function(){
										new_memberships.push( $(this).val() );
									});
									
									// find and remove the current wg id
									current_cat_idx = $.inArray( cat_id, new_memberships );
									current_cat_idx > 0 && new_memberships.splice( current_cat_idx, 1 );
									
									// clever: http://stackoverflow.com/questions/1773069/using-jquery-to-compare-two-arrays
									valid = $( memberships ).not( new_memberships ).length == 0 && $( new_memberships ).not( memberships ).length == 0;
									
									! valid && alert('hey sneaky! whatchu doin to my form?');
									
									return valid;
									
								});

							
							// build the action link and place it on my placeholder
							$link = $(document.createElement('a'))
								.addClass('button tiny-button' + (is_member ? ' neg' : '') )
								.attr( {
									'href': '#',
									'id' : 'change_user_group_membership'
									})
								.html( '<i data-icon="' + (is_member ? '&#xe097;' : '&#xe0a2;') + '"></i> ' + (is_member ? 'Leave' : 'Join') + ' this User Group' )
								.appendTo($placeholder);
								

							$placeholder.one('click', function(e){				
								e.preventDefault();
								
								// Set the current category checkbox to its current opposite
								$input.prop('checked', ! $input.prop('checked') );
								
								// Disable the button
								$link.addClass('disabled').html('Submitting&hellip;');

								// Submit the form
								// (1) FF requires the form to be in the DOM to submit
								$form
									.appendTo('body') // (1)
									.submit();
							});
						} // end success()
					});
						
				});
			})()		
		</script>
	
	{/if}
	
{/exp:stash:set}

{if logged_in && logged_in_group_id == "1"}
<h1>Global variables</h1>
<?php $EE = get_instance(); print('<pre><code>'.print_r($EE->config->_global_vars, TRUE) . '</code></pre>');  ?>

<h1>Configuration variables</h1>
<?php
	print('<pre><code>'. print_r($this->EE->config->config, TRUE) . '</code></pre>');
?> 
{/if}
